name: QC Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  checks:
    name: QC Checks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: Use PHP 8.3
        uses: shivammathur/setup-php@7bf05c6b704e0b9bfee22300130a31b5ea68d593 # 2.36.0
        with:
          php-version: 8.3
          coverage: none
          tools: composer, cs2pr

      - name: Install
        run: |
          composer install
          ./vendor/squizlabs/php_codesniffer/bin/phpcs --config-set installed_paths vendor/escapestudios/symfony2-coding-standard

      - name: Check composer.json
        run: composer validate

      - name: PHPStan checks
        run: vendor/bin/phpstan analyse

      - name: PHPCS checks
        continue-on-error: true
        run: vendor/squizlabs/php_codesniffer/bin/phpcs --standard=./phpcs.xml --no-cache --parallel=1 --report-full --report-checkstyle=./phpcs-report.xml ./src ./tests

      - name: Show PHPCS results in PR
        run: cs2pr ./phpcs-report.xml

  tests:
    name: Tests PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        php-version: [8.3, 8.4]

    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: Use PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@7bf05c6b704e0b9bfee22300130a31b5ea68d593 # 2.36.0
        with:
          php-version: ${{ matrix.php-version }}
          coverage: none
          tools: composer

      - name: Install
        run: |
          composer install
          ./vendor/squizlabs/php_codesniffer/bin/phpcs --config-set installed_paths vendor/escapestudios/symfony2-coding-standard

      - name: PHPUnit tests
        run: vendor/bin/phpunit
